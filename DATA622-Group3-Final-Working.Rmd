---
title: "CUNY SPS DATA 622 - Machine Learning and Big Data"
subtitle: 'Spring 2021 - Group 3 - Final'
author: "Maryluz Cruz, Amber Ferger, Tony Mei, and Charlie Rosemond"
date: "`r format(Sys.time(), '%B %d, %Y')`"
output: 
  html_document:
    theme: cerulean
    highlight: pygments
    toc: 3
urlcolor: purple
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo=FALSE, error = FALSE, warning = FALSE, message = FALSE, fig.align = "center")
```

### R Packages

The `R` language is used to facilitate data modeling. The main `R` packages used for data wrangling, visualization, and graphics are listed below.

```{r libraries, echo=TRUE}
# Required R packages
library(tidyverse)
library(kableExtra)
library(skimr)
library(corrplot)
library(e1071)
library(dummies)
library(caret)

```

### Overview {.tabset .tabset-fade .tabset.-pills}

This analysis employs a variety of classification algorithms to predict fetal health status using a cardiotocogram (CTG) dataset. It begins with exploratory data analysis (EDA) and preprocessing followed by a series of predictive models. It ends with an evaluation of model performance.

All references and a technical appendix of all R code are available at the end of this report.

***
<center> **PROJECT SECTIONS** </center>
***

### Exploratory Data Analysis (EDA)

EDA uses summary statistics and univariate and bivariate visualizations to summarize the CTG dataset, its response, and the initial set of possible features. This information will inform preprocessing of the dataset prior to modeling.

#### Dataset

Sourced from a 2000 research project and deidentified, the dataset consists of samples describing selected health characteristics of individual fetuses. It contains 2,126 samples and 22 total variables, including a target `fetal_health` with three classes: 'Normal', 'Suspect', and 'Pathological'. The available features for modeling range from the fetal heart rate (FHR) baseline (`baseline_value`) to the number of prolonged decelerations per second (`prolonged_decelerations`) to varied characteristics of FHR distribution (`histogram_*`). All variables in the dataset are listed and described below.

*Dataset Descriptions*
Variable | Description
------|------
'baseline_value' | Fetal heart rate (FHR) baseline (beats per minute)
'accelerations' | # of accelerations per second
'fetal_movement' | # of fetal movements per second
'uterine_contractions' | # of uterine contractions per second
'light_decelerations' | # of light decelerations per second
'severe_decelerations' | # of severe decelerations per second
'prolonged_decelerations' | # of prolonged decelerations per second
'abnormal_short_var' | % of time with abnormal short term variability
'mean_short_var' | Mean value of short term variability
'perc_time_long_var' | % of time with abnormal long term variability
'mean_long_var' | Mean value of long term variability
'histogram_width'| Width of FHR histogram
'histogram_min' | Minimum (low frequency) of FHR histogram
'histogram_max' | Maximum (high frequency) of FHR histogram
'histogram_peaks' | # of histogram peaks
'histogram_zeroes' | # of histogram zeroes
'histogram_mode' | Histogram mode
'histogram_mean' | Histogram mean
'histogram_median' | Histogram median
'histogram_variance' | Histogram variance
'histogram_tendency' | Histogram tendency
'fetal_health' | 1 (Normal), 2 (Suspect), 3 (Pathological) - TARGET


```{r load, message=FALSE, warning=FALSE}
df <- read_csv('https://raw.githubusercontent.com/chrosemo/DATA622-Group3-Final/main/fetal_health.csv')
df <- df %>% rename(baseline_value = 'baseline value',
                    prolonged_decelerations = 'prolongued_decelerations',
                    abnormal_short_var = 'abnormal_short_term_variability',
                    mean_short_var = 'mean_value_of_short_term_variability',
                    perc_time_long_var = 'percentage_of_time_with_abnormal_long_term_variability',
                    mean_long_var = 'mean_value_of_long_term_variability',
                    histogram_peaks = 'histogram_number_of_peaks',
                    histogram_zeroes = 'histogram_number_of_zeroes') %>% 
             mutate(fetal_health = as.factor(fetal_health))
```

#### Summary Statistics

```{r summarystats}
skim(df) %>% dplyr::select(-n_missing, -numeric.sd, -numeric.p25, -numeric.p75)
```

Summary statistics reveal useful information about the dataset. First, the dataset contains zero missing values. This completeness renders imputation, which can rest on tenuous assumptions, unnecessary. Second, beyond the categorical target `fetal_health`, all of the features are numeric, though their scales vary substantially. Thus centering and scaling could facilitate modeling. Third, many features display strong rightward skew, which suggests additional transformation may be necessary as well. And fourth, the classes of `fetal_health` are highly imbalanced. The largest class, "Normal" (1), consists of 1,655 samples compared to 295 samples for "Suspect" (2) and 176 samples for "Pathological" (3). This issue can be mitigated through over- or under-sampling.

#### Feature Distributions

Next comes visualization of the dataset features and their relations to the target `fetal_health`. The following two figures depict sets of feature-specific boxplots by class of `fetal_health`. Broadly, the boxplots reveal clear class-related differences in the distributions of the features.

```{r boxplots1, fig.cap='Feature boxplots by fetal health'}
df %>% 
  select(baseline_value:mean_long_var, fetal_health) %>%
  gather(key = 'variable', value = 'value', -fetal_health) %>%
  ggplot(aes(x = '', y = value, fill = fetal_health)) +
    facet_wrap(~ variable, scales = 'free') +
    geom_boxplot() +
    coord_flip() +
    labs(x = NULL, y = NULL) +
    theme(axis.text.x = element_text(angle = 45)) +
    scale_fill_manual(name = 'Fetal health',
                      guide = guide_legend(reverse=TRUE),
                      labels = c('Normal (1)', 'Suspect (2)', 'Pathological (3)'),
                      values = c('forestgreen', 'gold', 'red'))
```

The first set of plots focuses on the eleven non-histogram features: `baseline_value`, `accelerations`, `fetal_movement`, `uterine_contractions`, `light_decelerations`, `severe_decelerations`, `prolonged_decelerations`, `abnormal_short_var`, `mean_short_var`, `perc_time_long_var`, and `mean_long_var`. There are clear differences across classes of `fetal_health`. Notably, the IQRs of the distributions of  `abnormal_short_var` and `accelerations` for the "Normal" class show minimal overlap with their counterparts for the other two classes. Features `light_decelerations` and `baseline_value` possess similar relationships for the "Suspect" class, as does `prolonged_decelerations` for the "Pathological" class. Skewness is common across features, particularly for `fetal_movement` and `severe_decelerations`, though level of skewness tends to vary by class within features (e.g., "Normal" for `perc_time_long_var`).

```{r boxplots2, fig.cap='Feature boxplots by fetal health, continued'}
df %>% 
  select(histogram_width:histogram_tendency, fetal_health) %>%
  gather(key = 'variable', value = 'value', -fetal_health) %>%
  ggplot(aes(x = '', y = value, fill = fetal_health)) +
    facet_wrap(~ variable, scales = 'free') +
    geom_boxplot() +
    coord_flip() +
    labs(x = NULL, y = NULL) +
    scale_fill_manual(name = 'Fetal health',
                      guide = guide_legend(reverse=TRUE),
                      labels = c('Normal (1)', 'Suspect (2)', 'Pathological (3)'),
                      values = c('forestgreen', 'gold', 'red'))
```

The second set of plots focuses on the ten histogram features: `histogram_width`, `histogram_min`, `histogram_max`, `histogram_peaks`, `histogram_zeroes`, `histogram_mode`, `histogram_mean`, `histogram_median`, `histogram_variance`, and `histogram_tendency`. Several observations jump out. First, the three measure of central tendency features show different distributions across classes of `fetal_health`, but those distributions are similar regardless of measure. Second, there is less skewness among this set of features, though it is still present and is substantial for `histogram_peaks`, `histogram_variance`, and `histogram_zeroes`; there are particular class differences in variance. And third, for `histogram_tendency`, the distribution for the "Pathological" class is predominantly negative versus the predominantly positive distributions for the "Normal" and "Suspect" classes.

#### Feature Correlations

The feature names and descriptions suggest that groups of features are correlated, which could pose problems of collinearity during modeling. Considering the marked differences in feature distributions by class of `fetal_health`, it is appropriate to calculate any correlations separately for each class. Further, across features and classes, distributions are typically skewed, which calls for the non-parametric Spearman's rho. Below are correlation heat maps using Spearman's rho for all features and by class of `fetal_health`.

```{r correlations1, fig.cap="Spearman's correlation heat map of features, Fetal health: Normal (1)"}
corrplot(cor(df %>%
               filter(fetal_health == 1) %>%
               select(-fetal_health),
             method = 'spearman'))
```

Several patterns stand out for the "Normal" class. Understandably, the measure of central tendency features are highly positively correlated with one another but also with `baseline_value`. Likewise, the histogram shape features show notably strong correlations, including the negative correlations between `histogram_min` and each of `histogram_width`, `histogram_peaks`, and `histogram_variance`, and the positive correlations between `histogram_width` and each of `histogram_max`, `histogram_peaks`, and `histogram_variance`. Other features with somewhat strong correlations across features are `light_decelerations` and `mean_short_var`.

```{r correlations2, warning = FALSE, fig.cap="Spearman's correlation heat map of features, Fetal health: Suspect (2)"}
corrplot(cor(df %>%
               filter(fetal_health == 2) %>%
               select(-fetal_health),
             method = 'spearman'))
```

The heat map for the "Suspect" class repeats the general "Normal" patterns but with higher correlation values. There are stronger relationships between the histogram shape features and the non-histogram features. Additionally, the question marks for `severe_decelerations` indicate that there are zero values for that feature for this class.

```{r correlations3, fig.cap="Spearman's correlation heat map of features, Fetal health: Pathological (3)"}
corrplot(cor(df %>%
               filter(fetal_health == 3) %>%
               select(-fetal_health),
             method = 'spearman'))
```

The third heat map, for the "Pathological" class, continues the pattern of stronger correlations. Nearly all previously observed patterns are amplified, whether to the positive or the negative, for this class. A small set of features continues to show relatively weaker correlations, including `baseline_value` (aside from the measure of central tendency features), `accelerations`, `fetal_movement`, `severe_decelerations`, `mean_long_var`, `histogram_zeroes`, and `histogram_tendency`.

### Preprocessing

#### Imputation

#### Transformation


### Modeling

#### Support Vector Machine(SVM)

Support Vector Machine(SVM) is a supervised machine learning algorithm that can be used for classification or regression problems. Kernel is the technique used to transform ones data and then based on these transformations an optimal boundary is then found between the possible outputs. The data transformations are pretty complex, then separates your data based on the labels or outputs that have been defined.

SVM can be run using the e1071 package or the caret package. In the e1071 package the kernels are Linear, Radial, Polynomial or Sigimoid. In the caret package, the kernels are listed as svmLinear (for linear values), svmRadial (for non linear), and svmPoly (for nonlinear). When it is run within the svm function the kernals are listed differently in the in the e1071 it is listed under kernel, while in the caret package it is listed under method. For the purpose of this project, svmLinear will be used.

```{r}
# split the data into training set and testing set

set.seed(525)
which_train <- sample(x = c(TRUE, FALSE), 
                      size = nrow(df), 
                      replace = TRUE, 
                      prob = c(0.7, 0.3))

which_train

train_set <- df[which_train, ]
test_set <- df[!which_train, ]

train_set$fetal_health <-as.factor(train_set$fetal_health)
test_set$fetal_health <-as.factor(test_set$fetal_health)

#check if there is NA values
anyNA(df)

```

```{r}
summary(df)
```

Before training the model, the trainControl() method is implemented. This will control all the computational overheads so that it can use the train() function provided by the caret package. The training method will train the data on different algorithms.


```{r}

trctrl <- trainControl(method = "repeatedcv", number = 10, repeats = 3)

```

*The “method” parameter defines the resampling method, in this project the repeatedcv or the  repeated cross-validation method will be used.

*The next parameter is the “number”, this basically holds the number of resampling iterations.

*The “repeats ” parameter contains the sets to compute for the repeated cross-validation with setting number =10 and repeats =3


```{r}

svm_Linear <- train(fetal_health ~., data = train_set, method = "svmLinear",
trControl=trctrl,
preProcess = c("center", "scale"),
tuneLength = 10)
```

```{r}
svm_Linear
```

```{r}
test_pred <- predict(svm_Linear, newdata = test_set)
test_pred
```

```{r}
confusionMatrix(table(test_pred, test_set$fetal_health))

```

The output shows that the model accuracy for test set is 89.55%

#### SVM Improved Model

```{r}
grid <- expand.grid(C = c(0,0.01, 0.05, 0.1, 0.25, 0.5, 0.75, 1, 1.25, 1.5, 1.75, 2,5))
svm_Linear_Grid <- train(fetal_health ~., data = train_set, method = "svmLinear",
trControl=trctrl,
preProcess = c("center", "scale"),
tuneGrid = grid,
tuneLength = 10)
svm_Linear_Grid
plot(svm_Linear_Grid)

```

Accuracy was used to select the optimal model using the largest value.
The final value used for the model was C = 0.1.

Predict another model with Cost value of 0.1.

```{r}
test_pred_grid <- predict(svm_Linear_Grid, newdata = test_set)
test_pred_grid


```

```{r}
confusionMatrix(table(test_pred_grid, test_set$fetal_health))

```

The output shows that the improved model accuracy for test set is 90.48%.

#### SVM Conclusion
SVlinear is chosen in this project because of the linear values of the dataset. Using Cost value of 0.1 to make a more improved SVM model, the improved model predicts accurately with 90.48% for the 3 classifications of fetal health.

#### Sub

### Model Comparison


### Works Cited

https://www.kaggle.com/andrewmvd/fetal-health-classification

Ayres de Campos et al. (2000) SisPorto 2.0 A Program for Automated Analysis of Cardiotocograms. J Matern Fetal Med 5:311-318

Hamid Rashkiany. “Support Vector Machine In R: Using SVM To Predict Heart Diseases.” Edureka, 15 May 2020, www.edureka.co/blog/support-vector-machine-in-r/. 


### Code Appendix

The code chunks below represent the R code called in order during the analysis. They are reproduced in the appendix for review and comment.

```{r appendix, include=FALSE}
```
```{r load}
```
```{r summarystats}
```
```{r boxplots1, fig.cap='Feature boxplots by fetal health'}
```
```{r boxplots2, fig.cap='Feature boxplots by fetal health, continued'}
```
```{r correlations1, fig.cap="Spearman's correlation heat map of features, Fetal health: Normal (1)"}
```
```{r correlations2, warning = FALSE, fig.cap="Spearman's correlation heat map of features, Fetal health: Suspect (2)"}
```
```{r correlations3, fig.cap="Spearman's correlation heat map of features, Fetal health: Pathological (3)"}
```

