---
title: "CUNY SPS DATA 622 - Machine Learning and Big Data"
subtitle: 'Spring 2021 - Group 3 - Final'
author: "Maryluz Cruz, Amber Ferger, Tony Mei, and Charlie Rosemond"
date: "`r format(Sys.time(), '%B %d, %Y')`"
output: 
  html_document:
    theme: cerulean
    highlight: pygments
    toc: 3
urlcolor: purple
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo=FALSE, error = FALSE, warning = FALSE, message = FALSE, fig.align = "center")
```

### R Packages

The `R` language is used to facilitate data modeling. The main `R` packages used for data wrangling, visualization, and graphics are listed below.

```{r libraries, echo=TRUE}
# Required R packages
library(tidyverse)
library(kableExtra)
library(skimr)
library(corrplot)
library(e1071)
library(dummies)
library(caret)

```

### Overview {.tabset .tabset-fade .tabset.-pills}

This analysis employs a variety of classification algorithms to predict fetal health status using a cardiotocogram (CTG) dataset. It begins with exploratory data analysis (EDA) and preprocessing followed by a series of predictive models. It ends with an evaluation of model performance.

All references and a technical appendix of all R code are available at the end of this report.

***
<center> **PROJECT SECTIONS** </center>
***

### Exploratory Data Analysis (EDA)

EDA uses summary statistics and univariate and bivariate visualizations to summarize the CTG dataset, its response, and the initial set of possible features. This information will inform preprocessing of the dataset prior to modeling.

#### Dataset

Sourced from a 2000 research project and deidentified, the dataset consists of samples describing selected health characteristics of individual fetuses. It contains 2,126 samples and 22 total variables, including a target `fetal_health` with three classes: 'Normal', 'Suspect', and 'Pathological'. The available features for modeling range from the fetal heart rate (FHR) baseline (`baseline_value`) to the number of prolonged decelerations per second (`prolonged_decelerations`) to varied characteristics of FHR distribution (`histogram_*`). All variables in the dataset are listed and described below.

*Dataset Descriptions*
Variable | Description
------|------
'baseline_value' | Fetal heart rate (FHR) baseline (beats per minute)
'accelerations' | # of accelerations per second
'fetal_movement' | # of fetal movements per second
'uterine_contractions' | # of uterine contractions per second
'light_decelerations' | # of light decelerations per second
'severe_decelerations' | # of severe decelerations per second
'prolonged_decelerations' | # of prolonged decelerations per second
'abnormal_short_var' | % of time with abnormal short term variability
'mean_short_var' | Mean value of short term variability
'perc_time_long_var' | % of time with abnormal long term variability
'mean_long_var' | Mean value of long term variability
'histogram_width'| Width of FHR histogram
'histogram_min' | Minimum (low frequency) of FHR histogram
'histogram_max' | Maximum (high frequency) of FHR histogram
'histogram_peaks' | # of histogram peaks
'histogram_zeroes' | # of histogram zeroes
'histogram_mode' | Histogram mode
'histogram_mean' | Histogram mean
'histogram_median' | Histogram median
'histogram_variance' | Histogram variance
'histogram_tendency' | Histogram tendency
'fetal_health' | 1 (Normal), 2 (Suspect), 3 (Pathological) - TARGET


```{r load, message=FALSE, warning=FALSE}
df <- read_csv('https://raw.githubusercontent.com/chrosemo/DATA622-Group3-Final/main/fetal_health.csv')
df <- df %>% rename(baseline_value = 'baseline value',
                    prolonged_decelerations = 'prolongued_decelerations',
                    abnormal_short_var = 'abnormal_short_term_variability',
                    mean_short_var = 'mean_value_of_short_term_variability',
                    perc_time_long_var = 'percentage_of_time_with_abnormal_long_term_variability',
                    mean_long_var = 'mean_value_of_long_term_variability',
                    histogram_peaks = 'histogram_number_of_peaks',
                    histogram_zeroes = 'histogram_number_of_zeroes') %>% 
             mutate(fetal_health = as.factor(fetal_health))
```

#### Summary Statistics

```{r summarystats}
skim(df) %>% dplyr::select(-n_missing, -numeric.sd, -numeric.p25, -numeric.p75)
```

Summary statistics reveal useful information about the dataset. First, the dataset contains zero missing values. This completeness renders imputation, which can rest on tenuous assumptions, unnecessary. Second, beyond the categorical target `fetal_health`, all of the features are numeric, though their scales vary substantially. Thus centering and scaling could facilitate modeling. Third, many features display strong rightward skew, which suggests additional transformation may be necessary as well. And fourth, the classes of `fetal_health` are highly imbalanced. The largest class, "Normal" (1), consists of 1,655 samples compared to 295 samples for "Suspect" (2) and 176 samples for "Pathological" (3). This issue can be mitigated through over- or under-sampling.

#### Feature Distributions

Next comes visualization of the dataset features and their relations to the target `fetal_health`. The following two figures depict sets of feature-specific boxplots by class of `fetal_health`. Broadly, the boxplots reveal clear class-related differences in the distributions of the features.

```{r boxplots1, fig.cap='Feature boxplots by fetal health'}
df %>% 
  select(baseline_value:mean_long_var, fetal_health) %>%
  gather(key = 'variable', value = 'value', -fetal_health) %>%
  ggplot(aes(x = '', y = value, fill = fetal_health)) +
    facet_wrap(~ variable, scales = 'free') +
    geom_boxplot() +
    coord_flip() +
    labs(x = NULL, y = NULL) +
    theme(axis.text.x = element_text(angle = 45)) +
    scale_fill_manual(name = 'Fetal health',
                      guide = guide_legend(reverse=TRUE),
                      labels = c('Normal (1)', 'Suspect (2)', 'Pathological (3)'),
                      values = c('forestgreen', 'gold', 'red'))
```

```{r boxplots2, fig.cap='Feature boxplots by fetal health, continued'}
df %>% 
  select(histogram_width:histogram_tendency, fetal_health) %>%
  gather(key = 'variable', value = 'value', -fetal_health) %>%
  ggplot(aes(x = '', y = value, fill = fetal_health)) +
    facet_wrap(~ variable, scales = 'free') +
    geom_boxplot() +
    coord_flip() +
    labs(x = NULL, y = NULL) +
    scale_fill_manual(name = 'Fetal health',
                      guide = guide_legend(reverse=TRUE),
                      labels = c('Normal (1)', 'Suspect (2)', 'Pathological (3)'),
                      values = c('forestgreen', 'gold', 'red'))
```

#### Feature Correlations

The feature names and descriptions suggest that groups of features are correlated, which could pose problems of collinearity during modeling. Considering the marked differences in feature distributions by class of `fetal_health`, it is appropriate to calculate any correlations separately for each class. Further, across features and classes, distributions are typically skewed, which calls for the non-parametric Spearman's rho. Below are correlation heat maps using Spearman's rho for each of the three classes of `fetal_health`.

```{r correlations1, fig.cap="Spearman's correlation heat map of features, Fetal health: Normal (1)"}
corrplot(cor(df %>%
               filter(fetal_health == 1) %>%
               select(-fetal_health),
             method = 'spearman'))
```

```{r correlations2, warning = FALSE, fig.cap="Spearman's correlation heat map of features, Fetal health: Suspect (2)"}
corrplot(cor(df %>%
               filter(fetal_health == 2) %>%
               select(-fetal_health),
             method = 'spearman'))
```

```{r correlations3, fig.cap="Spearman's correlation heat map of features, Fetal health: Pathological (3)"}
corrplot(cor(df %>%
               filter(fetal_health == 3) %>%
               select(-fetal_health),
             method = 'spearman'))
```

### Preprocessing

#### Imputation

#### Transformation


### Modeling

#### Sub

### Model Comparison


### Works Cited

https://www.kaggle.com/andrewmvd/fetal-health-classification

Ayres de Campos et al. (2000) SisPorto 2.0 A Program for Automated Analysis of Cardiotocograms. J Matern Fetal Med 5:311-318


### Code Appendix

The code chunks below represent the R code called in order during the analysis. They are reproduced in the appendix for review and comment.

```{r appendix, include=FALSE}
```
```{r load}
```
```{r summarystats}
```
```{r boxplots1, fig.cap='Feature boxplots by fetal health'}
```
```{r boxplots2, fig.cap='Feature boxplots by fetal health, continued'}
```
```{r correlations1, fig.cap="Spearman's correlation heat map of features, Fetal health: Normal (1)"}
```
```{r correlations2, warning = FALSE, fig.cap="Spearman's correlation heat map of features, Fetal health: Suspect (2)"}
```
```{r correlations3, fig.cap="Spearman's correlation heat map of features, Fetal health: Pathological (3)"}
```

